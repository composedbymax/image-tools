<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Color Focus</title>
  <style>
    :root {
      --bg-color: rgb(10, 10, 10);
      --panel-bg: rgba(10, 10, 10, 0.5);
      --text-color: rgba(224, 224, 224, 0.7);
      --accent: #00cc44;
      --success-color: #4CAF50;
      --danger-color: #f44336;
      --border-color: #333;
      --input-bg: #2c2c2c;
      --hover-color: #252525;
    }
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }
    body {
      font-family: 'Segoe UI', Arial, sans-serif;
      background-color: var(--bg-color);
      color: var(--text-color);
      height: 100vh;
      width: 100vw;
      overflow: hidden;
      display: flex;
      flex-direction: column;
    }
    
    header {
      background-color: var(--panel-bg);
      padding: 15px 20px;
      border-bottom: 1px solid var(--border-color);
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    
    h1 {
      font-size: 1.5rem;
      font-weight: 500;
    }
    
    .main-container {
      display: flex;
      flex: 1;
      height: calc(100vh - 60px);
      position: relative;
      overflow: hidden;
    }
    
    .canvas-container {
      flex: 1;
      display: flex;
      flex-direction: column;
      padding: 20px;
      overflow: hidden;
    }
    
    .drop-zone {
      flex: 1;
      border: 2px dashed var(--border-color);
      border-radius: 8px;
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: center;
      transition: border-color 0.3s, background-color 0.3s;
      position: relative;
      overflow: hidden;
    }
    
    .drop-zone.drag-over {
      border-color: var(--accent);
      background-color: rgba(33, 150, 243, 0.1);
    }
    
    .drop-zone p {
      margin: 10px 0;
      color: #888;
    }
    canvas {
      max-width: 100%;
      max-height: 100%;
      object-fit: contain;
      display: none;
    }
    
    .canvas-visible {
      display: block;
    }
    
    .file-input-wrapper {
      margin-top: 15px;
    }
    
    .file-input-button {
      background-color: var(--input-bg);
      color: var(--text-color);
      border: 1px solid var(--border-color);
      padding: 8px 15px;
      border-radius: 4px;
      cursor: pointer;
      transition: background-color 0.3s;
    }
    
    .file-input-button:hover {
      background-color: var(--hover-color);
    }
    
    input[type="file"] {
      display: none;
    }
    
    .side-panel {
      width: 350px;
      background-color: var(--panel-bg);
      border-left: 1px solid var(--border-color);
      transform: translateX(350px);
      transition: transform 0.3s ease;
      position: absolute;
      top: 0;
      right: 0;
      height: 100%;
      overflow-y: auto;
      padding: 20px;
      z-index: 10;
    }
    
    .side-panel.open {
      transform: translateX(0);
    }
    
    .panel-toggle {
  position: absolute;
  right: 350px; /* Position relative to the right edge of the container */
  top: 20px;
  background-color: var(--panel-bg);
  border: 1px solid var(--border-color);
  border-right: none;
  border-radius: 4px 0 0 4px;
  width: 40px;
  height: 40px;
  display: flex;
  justify-content: center;
  align-items: center;
  cursor: pointer;
  color: var(--text-color);
  font-size: 1.2rem;
  z-index: 20; /* Make sure it's above other elements */
  transition: right 0.3s ease; /* Add transition to match panel movement */
}

/* Add a new class for toggle button when panel is closed */
.panel-toggle.panel-closed {
  right: 0; /* Move button to the edge when panel is closed */
}
    
    .download-button {
      background: var(--success-color);
      color: white;
      border: none;
      padding: 10px 15px;
      font-size: 1rem;
      border-radius: 4px;
      cursor: pointer;
      transition: background 0.3s;
      margin-left: 10px;
    }
    
    .download-button:hover:not(:disabled) {
      background: #45a049;
    }
    
    .download-button:disabled {
      background: #333;
      cursor: not-allowed;
      opacity: 0.6;
    }
    
    #addLayerSection {
      margin: 15px 0;
      padding: 15px;
      background-color: rgba(255, 255, 255, 0.05);
      border-radius: 6px;
    }
    
    #addLayerSection h3 {
      margin-bottom: 15px;
      font-weight: 500;
      font-size: 1rem;
    }
    
    .layer-form {
      display: flex;
      flex-direction: column;
      gap: 15px;
    }
    
    .form-group {
      display: flex;
      flex-direction: column;
      gap: 5px;
    }
    
    .form-group label {
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    
    input[type="color"] {
      width: 40px;
      height: 30px;
      border: none;
      background: none;
      cursor: pointer;
    }
    
    input[type="range"] {
      width: 100%;
      background-color: var(--input-bg);
      height: 5px;
      border-radius: 5px;
      -webkit-appearance: none;
      appearance: none;
    }
    
    input[type="range"]::-webkit-slider-thumb {
      -webkit-appearance: none;
      width: 15px;
      height: 15px;
      border-radius: 50%;
      background-color: var(--accent);
      cursor: pointer;
    }
    
    .add-layer-btn {
      background-color: var(--accent);
      color: white;
      border: none;
      padding: 8px 12px;
      border-radius: 4px;
      cursor: pointer;
      transition: background 0.3s;
      margin-top: 5px;
    }
    
    .add-layer-btn:hover {
      background-color: #1976D2;
    }
    
    .color-layer {
      display: flex;
      align-items: center;
      padding: 12px;
      margin-bottom: 12px;
      background: rgba(255, 255, 255, 0.05);
      border: 1px solid var(--border-color);
      border-radius: 6px;
    }
    
    .layer-preview {
      width: 25px;
      height: 25px;
      border: 1px solid var(--border-color);
      border-radius: 4px;
      margin-right: 12px;
    }
    
    .layer-controls {
      display: flex;
      flex-direction: column;
      flex-grow: 1;
      gap: 10px;
      width: 100%;
    }
    
    .layer-controls > div {
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    
    .layer-remove {
      color: var(--danger-color);
      font-size: 18px;
      cursor: pointer;
      margin-left: 10px;
      display: flex;
      align-items: center;
      justify-content: center;
      width: 24px;
      height: 24px;
    }
    
    .empty-layer-message {
      color: #888;
      text-align: center;
      padding: 20px;
    }
  </style>
</head>
<body>
  <header>
    <h1>Multi-Color Focus Filter</h1>
    <button id="downloadButton" class="download-button" disabled>Download Image</button>
  </header>
  <div class="main-container">
    <div class="canvas-container">
      <div id="dropZone" class="drop-zone">
        <div class="drop-zone-content">
          <p>Drag & drop image here</p>
          <p>or</p>
          <div class="file-input-wrapper">
            <label class="file-input-button">
              Choose File
              <input type="file" id="imageInput" accept="image/*">
            </label>
          </div>
        </div>
        <canvas id="canvas"></canvas>
      </div>
    </div>
    <div id="panelToggle" class="panel-toggle">≡</div>
    <div id="sidePanel" class="side-panel">
      <h2>Color Layers</h2>
      <div id="addLayerSection">
        <h3>Add New Color Layer</h3>
        <div class="layer-form">
          <div class="form-group">
            <label>
              Color:
              <input type="color" id="newLayerColor" value="#ff0000">
            </label>
          </div>
          <div class="form-group">
            <label>
              Tolerance: <span id="newToleranceValue">50</span>
            </label>
            <input type="range" id="newLayerTolerance" min="0" max="150" value="50">
          </div>
          <div class="form-group">
            <label>
              Hue Rotation: <span id="newHueValue">0</span>
            </label>
            <input type="range" id="newLayerHue" min="0" max="360" value="0">
          </div>
          <button id="addLayerButton" class="add-layer-btn">Add Color Layer</button>
        </div>
      </div>
      <div id="layersList"></div>
    </div>
  </div>
  <script>
    const canvas = document.getElementById('canvas'),
          imageInput = document.getElementById('imageInput'),
          downloadButton = document.getElementById('downloadButton'),
          newLayerColor = document.getElementById('newLayerColor'),
          newLayerTolerance = document.getElementById('newLayerTolerance'),
          newToleranceValue = document.getElementById('newToleranceValue'),
          newLayerHue = document.getElementById('newLayerHue'),
          newHueValue = document.getElementById('newHueValue'),
          addLayerButton = document.getElementById('addLayerButton'),
          layersList = document.getElementById('layersList'),
          sidePanel = document.getElementById('sidePanel'),
          panelToggle = document.getElementById('panelToggle'),
          dropZone = document.getElementById('dropZone');
    let originalImage = null, colorLayers = [], idCounter = 0, gl, program, posBuffer, texture;
    const MAX_LAYERS = 10;
    let uLoc = {};
    panelToggle.addEventListener('click', () => {
      sidePanel.classList.toggle('open');
      panelToggle.classList.toggle('panel-closed');
      panelToggle.textContent = sidePanel.classList.contains('open') ? '›' : '≡';
    });
    sidePanel.classList.add('open');
    panelToggle.textContent = '›';
    newLayerTolerance.oninput = () => newToleranceValue.textContent = newLayerTolerance.value;
    newLayerHue.oninput = () => newHueValue.textContent = newLayerHue.value;
    addLayerButton.onclick = () => {
      const color = newLayerColor.value,
            tolerance = +newLayerTolerance.value,
            hue = +newLayerHue.value,
            r = parseInt(color.slice(1,3),16),
            g = parseInt(color.slice(3,5),16),
            b = parseInt(color.slice(5,7),16);
      colorLayers.push({ id: 'layer-' + idCounter++, color, tolerance, hue, r, g, b });
      updateLayersList();
      processImage();
    };
    layersList.addEventListener('input', e => {
      const target = e.target, id = target.closest('.color-layer').id,
            layer = colorLayers.find(l => l.id === id);
      if (!layer) return;
      if (target.type === 'color') {
        layer.color = target.value;
        layer.r = parseInt(target.value.slice(1,3),16);
        layer.g = parseInt(target.value.slice(3,5),16);
        layer.b = parseInt(target.value.slice(5,7),16);
        target.closest('.color-layer').querySelector('.layer-preview').style.backgroundColor = target.value;
      } else if (target.type === 'range') {
        if(target.name === 'tolerance') {
          layer.tolerance = +target.value;
          const span = target.parentElement.querySelector('span');
          if (span) span.textContent = target.value;
        }
        if(target.name === 'hue') {
          layer.hue = +target.value;
          const span = target.parentElement.querySelector('span');
          if (span) span.textContent = target.value;
        }
      }
      processImage();
    });
    layersList.addEventListener('click', e => {
      if(e.target.classList.contains('layer-remove')){
        const id = e.target.closest('.color-layer').id;
        colorLayers = colorLayers.filter(l => l.id !== id);
        updateLayersList();
        processImage();
      }
    });
    function updateLayersList() {
      if (!colorLayers.length) { 
        layersList.innerHTML = '<p class="empty-layer-message">No color layers added. The entire image will be grayscale.</p>'; 
        return; 
      }
      layersList.innerHTML = '';
      colorLayers.forEach(layer => {
        layersList.insertAdjacentHTML('beforeend', `
          <div class="color-layer" id="${layer.id}">
            <div class="layer-preview" style="background:${layer.color}"></div>
            <div class="layer-controls">
              <div>
                <label>Color:</label>
                <input type="color" name="color" value="${layer.color}">
              </div>
              <div>
                <label>Tolerance: </label>
                <input type="range" name="tolerance" min="0" max="150" value="${layer.tolerance}">
                <span>${layer.tolerance}</span>
              </div>
              <div>
                <label>Hue: </label>
                <input type="range" name="hue" min="0" max="360" value="${layer.hue}">
                <span>${layer.hue}</span>
              </div>
            </div>
            <div class="layer-remove" title="Remove this layer">✕</div>
          </div>
        `);
      });
    }
    function initWebGL() {
      gl = canvas.getContext('webgl');
      if (!gl) return alert('WebGL not supported.');
      const vs = `
        attribute vec2 a_position;
        varying vec2 v_texCoord;
        void main(){ gl_Position = vec4(a_position*2.0-1.0, 0,1); v_texCoord = a_position; }
      `;
      const fs = `
        precision mediump float;
        varying vec2 v_texCoord;
        uniform sampler2D u_image; uniform vec2 u_resolution;
        const int MAX_LAYERS = ${MAX_LAYERS};
        uniform vec3 u_layerColors[MAX_LAYERS];
        uniform float u_layerTolerances[MAX_LAYERS];
        uniform float u_layerHues[MAX_LAYERS];
        uniform int u_numLayers;
        vec3 rgb2hsl(vec3 c){ float maxc = max(max(c.r,c.g),c.b), minc = min(min(c.r,c.g),c.b), h=0.0, s=0.0, l=(maxc+minc)/2.0;
          if(maxc!=minc){ float d = maxc-minc; s = l>0.5? d/(2.0-maxc-minc): d/(maxc+minc);
          h = maxc==c.r? (c.g-c.b)/d+(c.g<c.b?6.0:0.0) : maxc==c.g? (c.b-c.r)/d+2.0 : (c.r-c.g)/d+4.0; h /=6.0; } return vec3(h,s,l); }
        float hue2rgb(float p, float q, float t){ if(t<0.0)t+=1.0; if(t>1.0)t-=1.0; return t<1.0/6.0?p+(q-p)*6.0*t: t<1.0/2.0?q: t<2.0/3.0?p+(q-p)*(2.0/3.0-t)*6.0:p; }
        vec3 hsl2rgb(vec3 hsl){ if(hsl.y==0.0)return vec3(hsl.z); float q = hsl.z<0.5?hsl.z*(1.0+hsl.y): hsl.z+hsl.y-hsl.z*hsl.y, p = 2.0*hsl.z-q;
          return vec3(hue2rgb(p,q,hsl.x+1.0/3.0), hue2rgb(p,q,hsl.x), hue2rgb(p,q,hsl.x-1.0/3.0)); }
        void main(){
          vec4 tex = texture2D(u_image, v_texCoord);
          vec3 color = tex.rgb, outColor = vec3(0.0); bool matched=false;
          for(int i=0;i<MAX_LAYERS;i++){ if(i>=u_numLayers) break;
            if(length(color-u_layerColors[i])<=u_layerTolerances[i]){
              vec3 hsl = rgb2hsl(color); hsl.x = mod(hsl.x+u_layerHues[i],1.0);
              outColor = hsl2rgb(hsl); matched=true; break;
            }
          }
          if(!matched){ float gray = dot(color, vec3(0.299,0.587,0.114)); outColor = vec3(gray); }
          gl_FragColor = vec4(outColor, tex.a);
        }
      `;
      const compile = (type, src) => { let s = gl.createShader(type); gl.shaderSource(s,src); gl.compileShader(s); if(!gl.getShaderParameter(s, gl.COMPILE_STATUS)) { console.error(gl.getShaderInfoLog(s)); return null; } return s; };
      const vsShader = compile(gl.VERTEX_SHADER, vs), fsShader = compile(gl.FRAGMENT_SHADER, fs);
      program = gl.createProgram();
      gl.attachShader(program, vsShader); gl.attachShader(program, fsShader); gl.linkProgram(program);
      if(!gl.getProgramParameter(program, gl.LINK_STATUS)) { console.error(gl.getProgramInfoLog(program)); return; }
      gl.useProgram(program);
      ['u_image','u_resolution','u_layerColors','u_layerTolerances','u_layerHues','u_numLayers']
        .forEach(n=> uLoc[n]=gl.getUniformLocation(program,n));
      posBuffer = gl.createBuffer();
      gl.bindBuffer(gl.ARRAY_BUFFER, posBuffer);
      gl.bufferData(gl.ARRAY_BUFFER, new Float32Array([0,0, 1,0, 0,1, 0,1, 1,0, 1,1]), gl.STATIC_DRAW);
      const aPos = gl.getAttribLocation(program,"a_position");
      gl.enableVertexAttribArray(aPos);
      gl.vertexAttribPointer(aPos,2,gl.FLOAT,false,0,0);
    }
    function processImage() {
      if(!originalImage || !gl) return;
      canvas.width = originalImage.width; 
      canvas.height = originalImage.height;
      canvas.classList.add('canvas-visible');
      const dropContent = dropZone.querySelector('.drop-zone-content');
      if (dropContent) dropContent.style.display = 'none';
      gl.viewport(0,0,canvas.width,canvas.height);
      if(!texture) texture = gl.createTexture();
      gl.bindTexture(gl.TEXTURE_2D, texture);
      gl.pixelStorei(gl.UNPACK_FLIP_Y_WEBGL, true);
      gl.texImage2D(gl.TEXTURE_2D,0,gl.RGBA,gl.RGBA,gl.UNSIGNED_BYTE, originalImage);
      gl.texParameteri(gl.TEXTURE_2D, gl.TEXTURE_WRAP_S, gl.CLAMP_TO_EDGE);
      gl.texParameteri(gl.TEXTURE_2D, gl.TEXTURE_WRAP_T, gl.CLAMP_TO_EDGE);
      gl.texParameteri(gl.TEXTURE_2D, gl.TEXTURE_MIN_FILTER, gl.LINEAR);
      gl.uniform1i(uLoc.u_image, 0);
      gl.uniform2f(uLoc.u_resolution, canvas.width, canvas.height);
      const cols = [], tols = [], hues = [];
      colorLayers.slice(0, MAX_LAYERS).forEach(l => {
        cols.push(l.r/255, l.g/255, l.b/255);
        tols.push(l.tolerance/255);
        hues.push(l.hue/360);
      });
      while(cols.length < MAX_LAYERS*3) cols.push(0,0,0);
      while(tols.length < MAX_LAYERS) tols.push(0);
      while(hues.length < MAX_LAYERS) hues.push(0);
      gl.uniform3fv(uLoc.u_layerColors, new Float32Array(cols));
      gl.uniform1fv(uLoc.u_layerTolerances, new Float32Array(tols));
      gl.uniform1fv(uLoc.u_layerHues, new Float32Array(hues));
      gl.uniform1i(uLoc.u_numLayers, Math.min(colorLayers.length, MAX_LAYERS));
      gl.drawArrays(gl.TRIANGLES, 0, 6);
      downloadButton.disabled = false;
    }
    imageInput.onchange = e => {
      if(e.target.files?.[0]) {
        loadImageFile(e.target.files[0]);
      }
    };
    function loadImageFile(file) {
      const reader = new FileReader();
      reader.onload = event => { 
        originalImage = new Image(); 
        originalImage.onload = processImage; 
        originalImage.src = event.target.result; 
      };
      reader.readAsDataURL(file);
    }
    ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
      dropZone.addEventListener(eventName, e => {
        e.preventDefault();
        e.stopPropagation();
      });
    });
    dropZone.addEventListener('dragenter', () => {
      dropZone.classList.add('drag-over');
    });
    dropZone.addEventListener('dragover', () => {
      dropZone.classList.add('drag-over');
    });
    dropZone.addEventListener('dragleave', () => {
      dropZone.classList.remove('drag-over');
    });
    dropZone.addEventListener('drop', e => {
      dropZone.classList.remove('drag-over');
      if(e.dataTransfer.files?.length) {
        loadImageFile(e.dataTransfer.files[0]);
      }
    });
    downloadButton.onclick = () => {
      const a = document.createElement('a');
      a.download = 'multi-color-focus.png';
      a.href = canvas.toDataURL('image/png');
      a.click();
    };
    initWebGL(); 
    updateLayersList();
  </script>
</body>
</html>