<!DOCTYPE html>
<html>
<head>
    <title>Color Focus</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 20px auto;
            padding: 0 20px;
        }
        .controls {
            margin: 20px 0;
            display: flex;
            flex-wrap: wrap;
            gap: 15px;
            align-items: center;
        }
        canvas {
            max-width: 100%;
            border: 1px solid #ddd;
        }
        input[type="file"], button {
            border: 1px solid #ddd;
            padding: 5px;
            cursor: pointer;
        }
        #downloadButton {
            background-color: #4CAF50;
            color: white;
            border: none;
            padding: 10px 15px;
            text-align: center;
            text-decoration: none;
            display: inline-block;
            font-size: 16px;
            margin: 4px 2px;
            transition-duration: 0.4s;
        }
        #downloadButton:hover {
            background-color: #45a049;
        }
        #downloadButton:disabled {
            background-color: #cccccc;
            cursor: not-allowed;
        }
        .color-layer {
            display: flex;
            align-items: center;
            padding: 10px;
            margin-bottom: 10px;
            background-color: #f5f5f5;
            border-radius: 4px;
            border: 1px solid #ddd;
        }
        .layer-controls {
            display: flex;
            flex-grow: 1;
            flex-wrap: wrap;
            align-items: center;
            gap: 15px;
        }
        .layer-preview {
            width: 25px;
            height: 25px;
            border: 1px solid #ccc;
            margin-right: 10px;
        }
        .layer-tolerance,
        .layer-hue {
            display: flex;
            align-items: center;
            gap: 8px;
            min-width: 200px;
        }
        .layer-remove {
            color: red;
            font-size: 18px;
            cursor: pointer;
            margin-left: 10px;
        }
        #addLayerSection {
            margin: 20px 0;
            padding: 15px;
            background-color: #eaf5ff;
            border-radius: 4px;
            border: 1px solid #c5e1ff;
        }
        #addLayerButton {
            background-color: #2196F3;
            color: white;
            border: none;
            padding: 8px 12px;
            text-align: center;
            text-decoration: none;
            display: inline-block;
            font-size: 14px;
            margin: 4px 2px;
            transition-duration: 0.4s;
        }
        #addLayerButton:hover {
            background-color: #0b7dda;
        }
        #layersList {
            margin-top: 20px;
        }
    </style>
</head>
<body>
    <h1>Multi-Color Focus Filter with Hue Rotation</h1>
    <div class="controls">
        <input type="file" id="imageInput" accept="image/*">
        <button id="downloadButton" disabled>Download Processed Image</button>
    </div>
    <div id="addLayerSection">
        <h3>Add New Color Layer</h3>
        <div style="display: flex; flex-wrap: wrap; align-items: center; gap: 15px;">
            <div>
                <label for="newLayerColor">Color:</label>
                <input type="color" id="newLayerColor" value="#ff0000">
            </div>
            <div class="layer-tolerance">
                <label for="newLayerTolerance">Tolerance:</label>
                <input type="range" id="newLayerTolerance" min="0" max="150" value="50">
                <span id="newToleranceValue">50</span>
            </div>
            <div class="layer-hue">
                <label for="newLayerHue">Hue:</label>
                <input type="range" id="newLayerHue" min="0" max="360" value="0">
                <span id="newHueValue">0</span>
            </div>
            <button id="addLayerButton">Add Color Layer</button>
        </div>
    </div>
    <div id="layersList"></div>
    <canvas id="canvas"></canvas>
    <script>
        const canvas = document.getElementById('canvas');
        const ctx = canvas.getContext('2d', { willReadFrequently: true });
        const imageInput = document.getElementById('imageInput');
        const downloadButton = document.getElementById('downloadButton');
        const newLayerColor = document.getElementById('newLayerColor');
        const newLayerTolerance = document.getElementById('newLayerTolerance');
        const newToleranceValue = document.getElementById('newToleranceValue');
        const newLayerHue = document.getElementById('newLayerHue');
        const newHueValue = document.getElementById('newHueValue');
        const addLayerButton = document.getElementById('addLayerButton');
        const layersList = document.getElementById('layersList');
        let originalImage = null;
        let colorLayers = [];
        let layerIdCounter = 0;
        newLayerTolerance.addEventListener('input', function() {
            newToleranceValue.textContent = this.value;
        });
        newLayerHue.addEventListener('input', function() {
            newHueValue.textContent = this.value;
        });
        addLayerButton.addEventListener('click', function() {
            const color = newLayerColor.value;
            const tolerance = parseInt(newLayerTolerance.value);
            const hue = parseInt(newLayerHue.value);
            const layer = {
                id: 'layer-' + layerIdCounter++,
                color: color,
                r: parseInt(color.substr(1, 2), 16),
                g: parseInt(color.substr(3, 2), 16),
                b: parseInt(color.substr(5, 2), 16),
                tolerance: tolerance,
                hue: hue
            };
            colorLayers.push(layer);
            updateLayersList();
            processImage();
        });
        function updateLayersList() {
            layersList.innerHTML = '';
            if (colorLayers.length === 0) {
                layersList.innerHTML = '<p>No color layers added. The entire image will be grayscale.</p>';
                return;
            }
            colorLayers.forEach(layer => {
                const layerElement = document.createElement('div');
                layerElement.className = 'color-layer';
                layerElement.id = layer.id;
                const preview = document.createElement('div');
                preview.className = 'layer-preview';
                preview.style.backgroundColor = layer.color;
                const controls = document.createElement('div');
                controls.className = 'layer-controls';
                const colorPicker = document.createElement('div');
                colorPicker.innerHTML = `
                    <label for="${layer.id}-color">Color:</label>
                    <input type="color" id="${layer.id}-color" value="${layer.color}">
                `;
                const toleranceControl = document.createElement('div');
                toleranceControl.className = 'layer-tolerance';
                toleranceControl.innerHTML = `
                    <label for="${layer.id}-tolerance">Tolerance:</label>
                    <input type="range" id="${layer.id}-tolerance" min="0" max="150" value="${layer.tolerance}">
                    <span id="${layer.id}-tolerance-value">${layer.tolerance}</span>
                `;
                const hueControl = document.createElement('div');
                hueControl.className = 'layer-hue';
                hueControl.innerHTML = `
                    <label for="${layer.id}-hue">Hue:</label>
                    <input type="range" id="${layer.id}-hue" min="0" max="360" value="${layer.hue}">
                    <span id="${layer.id}-hue-value">${layer.hue}</span>
                `;
                const removeButton = document.createElement('div');
                removeButton.className = 'layer-remove';
                removeButton.innerHTML = 'âœ•';
                removeButton.title = 'Remove this color layer';
                controls.appendChild(colorPicker);
                controls.appendChild(toleranceControl);
                controls.appendChild(hueControl);
                layerElement.appendChild(preview);
                layerElement.appendChild(controls);
                layerElement.appendChild(removeButton);
                layersList.appendChild(layerElement);
                const colorInput = document.getElementById(`${layer.id}-color`);
                const toleranceInput = document.getElementById(`${layer.id}-tolerance`);
                const toleranceValueSpan = document.getElementById(`${layer.id}-tolerance-value`);
                const hueInput = document.getElementById(`${layer.id}-hue`);
                const hueValueSpan = document.getElementById(`${layer.id}-hue-value`);
                colorInput.addEventListener('input', function() {
                    updateLayerColor(layer.id, this.value);
                    preview.style.backgroundColor = this.value;
                });
                toleranceInput.addEventListener('input', function() {
                    updateLayerTolerance(layer.id, parseInt(this.value));
                    toleranceValueSpan.textContent = this.value;
                });
                hueInput.addEventListener('input', function() {
                    updateLayerHue(layer.id, parseInt(this.value));
                    hueValueSpan.textContent = this.value;
                });
                removeButton.addEventListener('click', function() {
                    removeLayer(layer.id);
                });
            });
        }
        function updateLayerColor(layerId, newColor) {
            const layerIndex = colorLayers.findIndex(l => l.id === layerId);
            if (layerIndex !== -1) {
                colorLayers[layerIndex].color = newColor;
                colorLayers[layerIndex].r = parseInt(newColor.substr(1, 2), 16);
                colorLayers[layerIndex].g = parseInt(newColor.substr(3, 2), 16);
                colorLayers[layerIndex].b = parseInt(newColor.substr(5, 2), 16);
                processImage();
            }
        }
        function updateLayerTolerance(layerId, newTolerance) {
            const layerIndex = colorLayers.findIndex(l => l.id === layerId);
            if (layerIndex !== -1) {
                colorLayers[layerIndex].tolerance = newTolerance;
                processImage();
            }
        }
        function updateLayerHue(layerId, newHue) {
            const layerIndex = colorLayers.findIndex(l => l.id === layerId);
            if (layerIndex !== -1) {
                colorLayers[layerIndex].hue = newHue;
                processImage();
            }
        }
        function removeLayer(layerId) {
            const layerIndex = colorLayers.findIndex(l => l.id === layerId);
            if (layerIndex !== -1) {
                colorLayers.splice(layerIndex, 1);
                updateLayersList();
                processImage();
            }
        }
        function rgbToHsl(r, g, b) {
            r /= 255; g /= 255; b /= 255;
            const max = Math.max(r, g, b);
            const min = Math.min(r, g, b);
            let h, s, l = (max + min) / 2;
            if(max === min) {
                h = s = 0;
            } else {
                const d = max - min;
                s = l > 0.5 ? d / (2 - max - min) : d / (max + min);
                switch(max) {
                    case r: h = (g - b) / d + (g < b ? 6 : 0); break;
                    case g: h = (b - r) / d + 2; break;
                    case b: h = (r - g) / d + 4; break;
                }
                h *= 60;
            }
            return [h, s, l];
        }
        function hslToRgb(h, s, l) {
            let r, g, b;
            h /= 360;
            if(s === 0) {
                r = g = b = l;
            } else {
                const hue2rgb = function(p, q, t) {
                    if(t < 0) t += 1;
                    if(t > 1) t -= 1;
                    if(t < 1/6) return p + (q - p) * 6 * t;
                    if(t < 1/2) return q;
                    if(t < 2/3) return p + (q - p) * (2/3 - t) * 6;
                    return p;
                }
                const q = l < 0.5 ? l * (1 + s) : l + s - l * s;
                const p = 2 * l - q;
                r = hue2rgb(p, q, h + 1/3);
                g = hue2rgb(p, q, h);
                b = hue2rgb(p, q, h - 1/3);
            }
            return [r * 255, g * 255, b * 255];
        }
        function processImage() {
            if (!originalImage) return;
            canvas.width = originalImage.width;
            canvas.height = originalImage.height;
            ctx.drawImage(originalImage, 0, 0);
            const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
            const data = imageData.data;
            for (let i = 0; i < data.length; i += 4) {
                const pixelR = data[i];
                const pixelG = data[i + 1];
                const pixelB = data[i + 2];
                let matched = false;
                for (const layer of colorLayers) {
                    const distance = Math.sqrt(
                        Math.pow(pixelR - layer.r, 2) +
                        Math.pow(pixelG - layer.g, 2) +
                        Math.pow(pixelB - layer.b, 2)
                    );
                    if (distance <= layer.tolerance) {
                        let [h, s, l] = rgbToHsl(pixelR, pixelG, pixelB);
                        h = (h + layer.hue) % 360;
                        const [nr, ng, nb] = hslToRgb(h, s, l);
                        data[i] = nr;
                        data[i + 1] = ng;
                        data[i + 2] = nb;
                        matched = true;
                        break;
                    }
                }
                if (!matched) {
                    const gray = 0.299 * pixelR + 0.587 * pixelG + 0.114 * pixelB;
                    data[i] = data[i + 1] = data[i + 2] = gray;
                }
            }
            ctx.putImageData(imageData, 0, 0);
            downloadButton.disabled = false;
        }
        imageInput.addEventListener('change', function(e) {
            if (!e.target.files || !e.target.files[0]) return;
            const reader = new FileReader();
            reader.onload = function(event) {
                originalImage = new Image();
                originalImage.onload = function() {
                    processImage();
                };
                originalImage.src = event.target.result;
            };
            reader.readAsDataURL(e.target.files[0]);
        });
        downloadButton.addEventListener('click', function() {
            if (!canvas.toDataURL) {
                alert('Your browser does not support image downloading.');
                return;
            }
            const link = document.createElement('a');
            link.download = 'multi-color-focus.png';
            link.href = canvas.toDataURL('image/png');
            link.click();
        });
        updateLayersList();
    </script>
</body>
</html>